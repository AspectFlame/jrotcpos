<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/theme.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://twitter.github.io/typeahead.js/releases/latest/typeahead.bundle.js"></script>
</head>

<body>
    <div class = "container">
        <div class="p-3 mb-2 bg-light text-dark">
            <h2><center>Recipient Info</center></h2>
            <p><center><b>Please enter all the information required for each recipient you would like to send carnations to. Once all the information required is filled out, you may either click continue to proceed or add another recipient.</b></center></p>
            <div id="recipientCards" class="row m-2">
            </div>
            <div class="modal fade" id="recipientModal" tabindex="-1" role="dialog" aria-labelledby="recipientModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recipientModalLabel">Recipient Information</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                    <div class="form-group">
                        <label for="recipient-email" class="col-form-label">Recipient Email:</label>
                        <select id="recipient-email" class="selectpicker show-tick" data-live-search="true" data-size="10">
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">Message:</label>
                        <textarea class="form-control" id="message-text"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="amount_of_carnations" class="col-form-label">Amount of Carnations:</label>
                        <div class="row" id="amount_of_carnations">
                            <div class="col" id="carnation_desc">
                                
                            </div>
                        </div>
                    </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="saveRecipient" class="btn btn-primary" data-dismiss="modal" data-currentmode="" disabled>Save Info</button>
                </div>
                </div>
            </div>
            </div>
            <div class="row">
                <div class="col-5">
                    <a class="btn btn-secondary float-left" href = "index.html">Back to Home</a>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#recipientModal" data-mode="add">New Recipient</button>
                </div>
                <div class="col-5">
                    <a class="btn btn-primary float-right" href = "customer.html">Next Page</a>
                </div>
                </div>
            </div>
            
            <script>
                items = null;
                users = null;
                userEmails = null;
                var recipientCards = new Array();
                function createButtons(data) {
                    result = '';
                    for (item of data) {
                        result += '<div class="row">';
                        result += '<div class="col-5"><b>' + item[1] + '</b></div>';
                        result += '<div class="col-2"><p>$' + item[3] + '</p></div>';
                        result += '<div class="col-5    ">';
                        result += '<input type="number" min="0" class="amountofcarnationsinputfield" id="' + item[0] + '_quantity" size="4">'
                        result += '</div></div>';
                    }
                    $('#carnation_desc').html(result);
                }
                params = new URLSearchParams(window.location.search);
                $(document).ready(function () {
                    $.ajax({
                        url: "http://localhost:5001/get_items",
                        context: this,
                        method: "post",
                        data: {'category_id': params.get('category')},
                        dataType: "json"
                    }).done(function (data, status) {
                        items = data;
                        createButtons(data);
                    });

                    $.ajax({
                        url: "http://localhost:5001/get_users",
                        context: this,
                        method: "post",
                        dataType: "json"
                    }).done(function (data, status) {
                        users = data;
                        userEmails = new Array();
                        for (user of users){
                            userEmails.push(user[3]);
                        }
                    });
                });
                
                $('#recipientModal').on('show.bs.modal', function (event) {
                    var modal = $(this);
                    var button = $(event.relatedTarget); // Button that triggered the modal
                    var currentmode = button.data('mode');// Extract info from data-* attributes
                    var index = button.data('index');
                    modal.find('.modal-title').text('Add recipient');
                    if ($('#recipient-email > option').length === 0) {
                        $('#recipient-email').append('<option value="null" selected>Nothing Selected</option>');
                        for (user of userEmails) {
                            $('#recipient-email').append('<option value="' + user + '">' + user + '</option>');
                        }
                    }
                    $('#recipient-email').selectpicker('refresh');

                    function checkInput() {
                        if ($('#recipientModal').find('#recipient-email').find(":selected").val().length > 0 && $('#recipientModal').find('#recipient-email').find(":selected").val() != 'null' && $('#recipientModal').find('#message-text').val().length > 0) {
                            for (item of items) {
                                if ($('#recipientModal').find('#' + item[0] + '_quantity').val().length == 0) {
                                    return false;
                                }
                            }
                            return true;
                        }
                        return false;
                    }
                    if (currentmode === 'edit') {
                        // we also want the id passed in the button
                        // use the id and pull up the recipient card from the card array 
                        // and set the values on the modal
                        var arrayIndex = button.data('index');
                        var aCard = recipientCards[arrayIndex];
                        modal.find('#recipient-email').val(aCard.recipientEmail);
                        $('#recipient-email').selectpicker('refresh');
                        modal.find('#message-text').val(aCard.message);
                        modal.find('.modal-title').text('Edit recipient');
                        values = aCard.values;
                        for (let [key, value] of Object.entries(values)) {
                            modal.find('#' + key + '_quantity').val(value);
                        }
                        modal.find("#saveRecipient").attr("data-index", index);
                    }

                    modal.find('#saveRecipient').prop('disabled', !checkInput());

                    modal.find('#recipient-email').on('change', function(event){
                        modal.find('#saveRecipient').prop('disabled', !checkInput());
                    });

                    modal.find('#message-text').blur(function(event){
                        modal.find('#saveRecipient').prop('disabled', !checkInput());
                    });

                    modal.find('.amountofcarnationsinputfield').blur(function(event){
                        var amountfield = $(this);
                        if (amountfield.val()<0) {
                            amountfield.val(0);
                        }   
                    });
                    for (item of items) {
                        modal.find('#' + item[0] + '_quantity').blur(function(event){
                            modal.find('#saveRecipient').prop('disabled', !checkInput());
                        });
                    }
                    modal.find("#saveRecipient").attr("data-currentmode", currentmode);
                });

                $('#saveRecipient').click(function(event){
                    if ($('#saveRecipient').attr('data-currentmode') === 'add'){
                        var newCard = new Object();
                        newCard.recipientEmail = $('#recipientModal').find('#recipient-email').val();
                        $('#recipientModal').find('#recipient-email').val('null');
                        $('#recipient-email').selectpicker('refresh');
                        newCard.message = $('#recipientModal').find('#message-text').val();
                        $('#recipientModal').find('#message-text').val('');
                        newCard.values = {};
                        for (item of items) {
                            newCard['values'][item[0]] = $('#recipientModal').find('#' + item[0] + '_quantity').val();
                            $('#recipientModal').find('#' + item[0] + '_quantity').val('');
                        }
                        recipientCards.push(newCard);
                        refreshCardsDiv();
                    }
                    else if ($('#saveRecipient').attr('data-currentmode') === 'edit'){
                        // take the value of the id passed in the button
                        // and pull the corresponding card from the array
                        var index = $('#saveRecipient').attr('data-index')
                        var newCard = new Object();
                        recipientCards[index].recipientEmail = $('#recipientModal').find('#recipient-email').val();
                        $('#recipientModal').find('#recipient-email').val('null');
                        $('#recipient-email').selectpicker('refresh');
                        recipientCards[index].message = $('#recipientModal').find('#message-text').val();
                        $('#recipientModal').find('#message-text').val('');
                        recipientCards[index].values = {};
                        for (item of items) {
                            recipientCards[index]['values'][item[0]] = $('#recipientModal').find('#' + item[0] + '_quantity').val();
                            $('#recipientModal').find('#' + item[0] + '_quantity').val('');
                        }
                        refreshCardsDiv();
                    }
                });

                function refreshCardsDiv(){
                    // lay out the cards from the recipientCards array
                    cardsHtml = '';
                    for (var i = 0; i < recipientCards.length; i++) {
                        var aCard = recipientCards[i];
                        cardsHtml += '<div class="col-4 mb-2">';
                        cardsHtml += '<div class="card h-100">';
                        cardsHtml += '<div class="card-header"><b>' + aCard.recipientEmail + '</b></div>';
                        cardsHtml += '<div class="card-body"><p class="mb-2">' + aCard.message + '</p>';
                        for (let [key, value] of Object.entries(aCard.values)) {
                            cardsHtml += '<p class="mb-0">' + getItemNameFromId(key) + ' x' + value + '</p>';
                        }
                        cardsHtml += '</div>';
                        cardsHtml += '<button type="button" id="editRecipient" class="btn btn-primary" data-toggle="modal" data-target="#recipientModal" data-mode="edit" data-index="'+ i + '">Edit</button>'
                        cardsHtml += '</div></div>';
                    }
                    $('#recipientCards').html(cardsHtml);
                }

                function getItemNameFromId(id) {
                    for (item of items) {
                        if (item[0] == id) {
                            return item[1];
                        }
                    }
                    return '';
                }
            </script>
        </div>
    </div>  
</body>
</html>